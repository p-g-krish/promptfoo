/**
 * Transform function for promptfoo to handle the Red Panda Motors chatbot API with threadId support
 *
 * This transform:
 * 1. Takes the user message and formats it as a chat API request
 * 2. Includes the threadId generated by the beforeEach hook
 * 3. Formats the chat history appropriately
 */
async function transform(prompt, { vars }) {
  // Extract the user message and threadId from vars
  const userMessage = vars.user_message;
  const threadId = vars.threadId || `thread_${Math.random().toString(36).substring(2, 15)}`;

  console.log(`Transform for test with threadId: ${threadId}`);

  // Create a chat message from the user input
  const chatMessage = {
    role: 'user',
    content: userMessage,
  };

  // Format the request body for the chatbot API
  // Includes user message and threadId
  const requestBody = {
    api_provider: 'openai',
    chat_history: [chatMessage],
    threadId,
  };

  // Return the formatted request as a JSON string
  return JSON.stringify(requestBody);
}

module.exports = transform;
